# The_Middleware
A middleware to support on-demand massive-scientific-data-visualization 


# HTTP interface

## header type
1. FirstContact (再初期化も含む)

header = {
    'type':'init',
    'offset':BlockOffset,
    'L3Size' : 1000,
    'L4Size': 1000,
    'Policy' :'LRU',
    'FileName' : 'test',
}

L3Sizeが0の時にはoffってことにします。

ここにリプレイスメントポリシーを入れるって感じにしたいと思います。キャッシュサイズも決められるようにしたいと思います。

2. BlockRequest

header = {
    'type':'BlockReq',
    'tol':BlockId[0],
    'timestep':BlockId[1],
    'x': BlockId[2],
    'y': BlockId[3],
    'z': BlockId[4]
}

この二つでいいかな？



## body
compressed array


## prefetch algorithm
これは、ユーザが見ているポイントを中心にどんどん入れていく感じにしよう

## replacement algorithm
単なるLRU?
ユーザ追尾型？radiusサーチ？

## キャッシュの大きさは一定。これは変わりません

# TODO

## client
- [x] リクエストを連続的に送信
- [ ] 初期コンタクトでサーバからデータの範囲を受信
- [x] 統計的に提案手法有意義であることを示すために、様々な解析パターンをどうにか用意しないといけない。どうすればいいのだろうか？--> 連続リクエストとランダムのミックスを使うしかないと思う。
- 現状、クライアントのAPIにリクエストするよりも、それをすっ飛ばして直接サーバにリクエストした方が早く終わる、という結果が出ています。つまり、クライアント側でバグが起こっていますと。どこで起こっているのか、解析しないといけません。そのために、pythonのプロファイラを使いたいと思います。
```
python -m cProfile -o main.prof my_script.py
```
このように実行することでプロファイルできますと。
さらに、line_profileっていうのもあるから、自分で調べてみて。
- [ ] 連続リクエストとランダムのミックスが対話的解析のリクエストとして妥当性があるのかどうか？そこを示す論文を探さないといけない。

## server
- [x] 各キャッシュのサイズをクライアント側から設定できるように
- [x] 各キャッシュのOn/Offをクライアント側からできるように
- [x] slicerがインデックス以上を読み込まないように注意。最初にスライサーを起動して各次元を読み込んできてもらって、それを各コンポーネントに渡す感じがいいと思う。
- [x] バグ：リスタートした後、L3Prefetcherが動かないことがある。これ、どうやって解決する？リスタート自体は、別にシステムに必須ではない。
--> これおそらく、ブロックサイズが大きすぎて、GPUが圧縮できないことに起因している気がしています。いや、普通に動いている。問題ない
- [ ] 現在、キャッシュのサイズは、そこに格納できる要素数で規定している。が、そうではなく、GiBで規定できるようにしたい。
- [ ] L3キャッシュの使用容量だけど、今は、圧縮前のサイズで計算している。これ、圧縮したデータを追加するようにしてほしい。よろしくお願いします。
- [ ] プレイフェッチポリシー、リプレイスメントポリシーを多数用意
- [ ] キャッシュにwayを追加？どうやって？
- [ ] キャッシュミスをしたときに、ミスをした箇所からプリフェッチを再開するみたいな。
- [ ] ユーザの動きを常に監視し、
- [ ] やはりHTTPだとオーバヘッドが大きい。というのも、一回一回コネクションを張らないといけないから。これのせいで、セッションも管理しないといけない。pythonでできるかわからないけど、通信部分も自分で書いた方がいいかもしれない。
- [ ] キャッシュのサイズから、最大の半径を計算するプログラムを書いてください。
- [ ] ミスが生じたときに、そのポイントから再びプリフェッチを始めるようなプログラムを書いてください。
- [ ] ユーザの動きを常に把握しながら、そのポイントを中心にプリフェッチをするプログラムを書いてください。
- [ ] 

## overall
- [ ] シンギュラリティーコンテナを作る。たのむ。動いてくれ。
- [ ] バグの個所を先生に見てもらう